#!/usr/bin/env python3
import requests
import re
import json
import sys
from getpass import getpass
from time import sleep
import os
import urllib.parse

def clear_screen():
    os.system('clear' if os.name == 'posix' else 'cls')

def show_banner():
    clear_screen()
    print("\033[1;36m")
    print("  _______  ______   _______  _______  _______  ___   _______  _______ ")
    print(" |       ||      | |       ||       ||       ||   | |       ||       |")
    print(" |    ___||  _    ||    ___||    ___||    ___||   | |_     _||    ___|")
    print(" |   |___ | | |   ||   |___ |   |___ |   |___ |   |   |   |  |   |___ ")
    print(" |    ___|| |_|   ||    ___||    ___||    ___||   |   |   |  |    ___|")
    print(" |   |    |       ||   |___ |   |    |   |___ |   |   |   |  |   |___ ")
    print(" |___|    |______| |_______||___|    |_______||___|   |___|  |_______|")
    print("\033[1;35m")
    print("            Token & Cookie Generator - Improved Version")
    print("\033[1;33m")
    print("-------------------------------------------------------------")
    print("\033[0m")
    sleep(2)

def get_login_params(html):
    params = {
        'lsd': re.search(r'name="lsd" value="(.*?)"', html).group(1),
        'jazoest': re.search(r'name="jazoest" value="(.*?)"', html).group(1),
        'm_ts': re.search(r'name="m_ts" value="(.*?)"', html).group(1),
        'li': re.search(r'name="li" value="(.*?)"', html).group(1)
    }
    return params

def get_fb_token(username, password):
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Mobile Safari/537.36',
        'Accept-Language': 'en-US,en;q=0.9',
        'Connection': 'keep-alive'
    })

    try:
        # Get initial cookies and login form
        print("\033[1;33mLoading Facebook login page...\033[0m")
        response = session.get('https://m.facebook.com/')
        login_params = get_login_params(response.text)
        
        # Prepare login data
        login_data = {
            'lsd': login_params['lsd'],
            'jazoest': login_params['jazoest'],
            'm_ts': login_params['m_ts'],
            'li': login_params['li'],
            'try_number': '0',
            'unrecognized_tries': '0',
            'email': username,
            'pass': password,
            'login': 'Log In',
            'bi_xrwh': '0'
        }
        
        # Perform login
        print("\033[1;33mAttempting login...\033[0m")
        response = session.post(
            'https://m.facebook.com/login/device-based/regular/login/',
            data=login_data,
            allow_redirects=True
        )
        
        # Check for successful login
        if 'c_user' in session.cookies:
            user_id = session.cookies.get('c_user')
            print("\033[1;32mLogin successful! Fetching profile...\033[0m")
            
            # Get profile name
            profile_response = session.get(f'https://m.facebook.com/profile.php?id={user_id}')
            name_match = re.search(r'<title>(.*?)<\/title>', profile_response.text)
            profile_name = name_match.group(1).split('|')[0].strip() if name_match else "Unknown"
            
            # Get access token
            print("\033[1;33mFetching access token...\033[0m")
            token_response = session.get(
                'https://m.facebook.com/dialog/oauth?client_id=124024574287414&redirect_uri=fbconnect://success&scope=email&response_type=token'
            )
            
            if 'access_token=' in token_response.url:
                access_token = token_response.url.split('access_token=')[1].split('&')[0]
            else:
                access_token = None
                print("\033[1;31mCould not extract access token from URL\033[0m")
            
            return {
                'status': 'success',
                'cookies': session.cookies.get_dict(),
                'access_token': access_token,
                'profile_name': profile_name,
                'user_id': user_id
            }
        elif 'checkpoint' in response.url:
            return {
                'status': 'checkpoint',
                'message': 'Account verification required. Please check your account.'
            }
        else:
            error_msg = "Login failed. Please check your credentials."
            if "The password you entered is incorrect" in response.text:
                error_msg = "Incorrect password. Please try again."
            elif "Your account has been locked" in response.text:
                error_msg = "Account locked. Please secure your account."
            return {
                'status': 'failed',
                'message': error_msg
            }
            
    except Exception as e:
        return {
            'status': 'error',
            'message': f'An error occurred: {str(e)}'
        }

def show_result(result):
    clear_screen()
    if result['status'] == 'success':
        print("\033[1;32mSUCCESS!\033[0m")
        print(f"\nProfile Name: \033[1;36m{result['profile_name']}\033[0m")
        print(f"User ID: \033[1;36m{result['user_id']}\033[0m")
        
        print("\n\033[1;35m=== Cookies ===\033[0m")
        print(json.dumps(result['cookies'], indent=2))
        
        print("\n\033[1;35m=== Access Token ===\033[0m")
        print(result['access_token'])
        
        print("\n\033[1;31mIMPORTANT: Keep this information secure!\033[0m")
    else:
        print("\033[1;31mERROR!\033[0m")
        print(f"\n\033[1;31m{result.get('message', 'Unknown error occurred')}\033[0m")

def main():
    show_banner()
    
    print("\033[1;33mDISCLAIMER:\033[0m")
    print("This tool generates Facebook access tokens for development purposes.")
    print("Your credentials are used only for authentication and are not stored.")
    print("\033[1;31mNever share your credentials or tokens with anyone!\033[0m")
    
    confirm = input("\nContinue? (yes/no): ").strip().lower()
    if confirm != 'yes':
        print("Exiting...")
        sys.exit(0)
    
    clear_screen()
    print("\033[1;34mFacebook Login\033[0m")
    username = input("\nEnter Facebook username/email/phone: ").strip()
    password = getpass("Enter Facebook password: ").strip()
    
    result = get_fb_token(username, password)
    show_result(result)
    
    if result['status'] == 'success':
        save = input("\nSave to file? (yes/no): ").strip().lower()
        if save == 'yes':
            filename = f"fb_{result['user_id']}_token.txt"
            with open(filename, 'w') as f:
                f.write(f"Profile: {result['profile_name']}\n")
                f.write(f"User ID: {result['user_id']}\n\n")
                f.write("Cookies:\n")
                f.write(json.dumps(result['cookies'], indent=2))
                f.write("\n\nToken:\n")
                f.write(result['access_token'])
            print(f"Saved to {filename}")
    
    print("\n\033[1;35mDone. Exiting...\033[0m")

if __name__ == "__main__":
    main()
